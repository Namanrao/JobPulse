<!-- my-applications.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Applications - JobPulse</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .applications-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .page-header {
        margin-bottom: 2rem;
      }

      .page-header h1 {
        font-size: 2rem;
        color: var(--dark);
        margin-bottom: 0.5rem;
      }

      .page-header p {
        color: var(--secondary);
      }

      .applications-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .application-item {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray);
        transition: all 0.3s;
      }

      .application-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }

      .application-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .job-info h3 {
        font-size: 1.2rem;
        color: var(--dark);
        margin-bottom: 0.5rem;
      }

      .job-info .company {
        color: var(--primary);
        font-weight: 500;
        margin-bottom: 0.25rem;
      }

      .job-info .location {
        color: var(--secondary);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .application-status {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-pending {
        background: #fef3c7;
        color: #92400e;
      }
      .status-reviewed {
        background: #dbeafe;
        color: #1e40af;
      }
      .status-shortlisted {
        background: #d1fae5;
        color: #065f46;
      }
      .status-accepted {
        background: #10b981;
        color: white;
      }
      .status-rejected {
        background: #fee2e2;
        color: #991b1b;
      }

      .application-details {
        margin: 1rem 0;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
      }

      .application-details p {
        margin-bottom: 0.5rem;
        color: var(--dark);
      }

      .application-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }

      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--secondary);
      }

      .empty-state i {
        font-size: 3rem;
        color: #ccc;
        margin-bottom: 1rem;
      }

      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: var(--secondary);
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container">
        <div class="nav-content">
          <a href="index.html" class="logo">
            <i class="fas fa-bolt"></i>
            <span>JobPulse</span>
          </a>

          <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="jobs.html">Jobs</a>
            <a href="my-applications.html" class="active">My Applications</a>

            <div id="authButtons">
              <!-- JavaScript se populate hoga -->
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Applications Content -->
    <div class="applications-container">
      <!-- Page Header -->
      <div class="page-header">
        <h1>My Job Applications</h1>
        <p>Track the status of all your job applications in one place</p>
      </div>

      <!-- Alert Container -->
      <div id="alertContainer"></div>

      <!-- Loading State -->
      <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading your applications...
      </div>

      <!-- Applications List -->
      <div id="applicationsContent" style="display: none">
        <div id="statsSection" style="display: none"></div>
        <div id="applicationsList" class="applications-list"></div>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="empty-state" style="display: none">
        <i class="fas fa-file-alt"></i>
        <h3>No applications yet</h3>
        <p>You haven't applied for any jobs yet.</p>
        <a href="jobs.html" class="btn btn-primary mt-3">
          <i class="fas fa-search"></i> Browse Jobs
        </a>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="logo">
            <i class="fas fa-bolt"></i>
            <span>JobPulse</span>
          </div>
          <p>&copy; 2024 JobPulse. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/applications.js"></script>

    <script>
      // Initialize page
      document.addEventListener("DOMContentLoaded", async function () {
        await initializePage();
      });

      // Initialize the page
      async function initializePage() {
        // Load authentication state
        auth.loadAuthState();

        // Check if user is logged in
        if (!api.isLoggedIn()) {
          window.location.href = "login.html";
          return;
        }

        // Check if user is a job seeker
        const userData = await api.getCurrentUser();
        const userRole = userData?.data?.role;

        if (userRole !== "JOB_SEEKER") {
          window.location.href = "index.html";
          return;
        }

        // Load applications
        await loadApplications();
      }

      // Load applications
      async function loadApplications() {
        const loading = document.getElementById("loading");
        const applicationsContent = document.getElementById(
          "applicationsContent"
        );
        const emptyState = document.getElementById("emptyState");

        try {
          const applications = await applicationsManager.getMyApplications();

          loading.style.display = "none";

          if (applications.length === 0) {
            emptyState.style.display = "block";
            return;
          }

          applicationsContent.style.display = "block";

          // Show stats
          displayStats(applications);

          // Show applications
          displayApplications(applications);
        } catch (error) {
          console.error("Error loading applications:", error);
          loading.innerHTML =
            '<div class="alert alert-error">Failed to load applications</div>';
        }
      }

      // Display statistics
      function displayStats(applications) {
        const statsSection = document.getElementById("statsSection");

        // Count applications by status
        const stats = {
          total: applications.length,
          pending: applications.filter((app) => app.status === "PENDING")
            .length,
          reviewed: applications.filter((app) => app.status === "REVIEWED")
            .length,
          shortlisted: applications.filter(
            (app) => app.status === "SHORTLISTED"
          ).length,
          accepted: applications.filter((app) => app.status === "ACCEPTED")
            .length,
          rejected: applications.filter((app) => app.status === "REJECTED")
            .length,
        };

        statsSection.style.display = "block";
        statsSection.innerHTML = `
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Total Applications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.pending}</div>
                        <div class="stat-label">Pending Review</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.shortlisted}</div>
                        <div class="stat-label">Shortlisted</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.accepted}</div>
                        <div class="stat-label">Accepted</div>
                    </div>
                </div>
            `;
      }

      // Display applications
      function displayApplications(applications) {
        const applicationsList = document.getElementById("applicationsList");

        applicationsList.innerHTML = applications
          .map(
            (application) => `
                <div class="application-item">
                    <div class="application-header">
                        <div class="job-info">
                            <h3>${application.job?.title || "Job Title"}</h3>
                            <p class="company">${
                              application.job?.company || "Company"
                            }</p>
                            <p class="location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${
                                  application.job?.location ||
                                  "Location not specified"
                                }
                            </p>
                        </div>
                        <div class="application-status status-${application.status.toLowerCase()}">
                            ${application.status}
                        </div>
                    </div>
                    
                    <div class="application-details">
                        <p><strong>Applied on:</strong> ${new Date(
                          application.appliedDate
                        ).toLocaleDateString()}</p>
                        ${
                          application.reviewedDate
                            ? `
                            <p><strong>Last reviewed:</strong> ${new Date(
                              application.reviewedDate
                            ).toLocaleDateString()}</p>
                        `
                            : ""
                        }
                        ${
                          application.coverLetter
                            ? `
                            <p><strong>Cover Letter:</strong> ${application.coverLetter.substring(
                              0,
                              100
                            )}...</p>
                        `
                            : ""
                        }
                    </div>
                    
                    <div class="application-actions">
                        <button onclick="viewJobDetails(${
                          application.job?.id
                        })" class="btn btn-primary">
                            <i class="fas fa-eye"></i> View Job
                        </button>
                        ${
                          application.status === "PENDING"
                            ? `
                            <button onclick="withdrawApplication(${application.id})" class="btn btn-danger">
                                <i class="fas fa-times"></i> Withdraw
                            </button>
                        `
                            : ""
                        }
                    </div>
                </div>
            `
          )
          .join("");
      }

      // View job details
      function viewJobDetails(jobId) {
        window.location.href = `job-details.html?id=${jobId}`;
      }

      // Withdraw application
      async function withdrawApplication(applicationId) {
        if (!confirm("Are you sure you want to withdraw this application?"))
          return;

        try {
          await applicationsManager.withdrawApplication(applicationId);
          auth.showAlert(
            "Application withdrawn successfully",
            "success",
            "alertContainer"
          );
          await loadApplications();
        } catch (error) {
          console.error("Error withdrawing application:", error);
          auth.showAlert(
            error.message || "Failed to withdraw application",
            "error",
            "alertContainer"
          );
        }
      }
    </script>
  </body>
</html>
