<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Browse Jobs - JobPulse</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
      /* Jobs page specific styles */
      .jobs-header {
        text-align: center;
        padding: 3rem 0 2rem;
      }

      .jobs-header h1 {
        font-size: 2.5rem;
        color: var(--dark);
        margin-bottom: 0.5rem;
      }

      .jobs-header p {
        color: var(--secondary);
        margin-bottom: 2rem;
        font-size: 1.1rem;
      }

      .search-box {
        display: flex;
        max-width: 700px;
        margin: 0 auto 1.5rem;
        gap: 1rem;
      }

      .search-box input {
        flex: 1;
        padding: 0.8rem 1.5rem;
        border: 2px solid var(--gray);
        border-radius: 6px;
        font-size: 1rem;
      }

      .search-box input:focus {
        outline: none;
        border-color: var(--primary);
      }

      .filters {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
      }

      .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
      }

      .filter-select,
      .filter-input {
        padding: 0.6rem 1rem;
        border: 2px solid var(--gray);
        border-radius: 6px;
        font-size: 0.9rem;
        min-width: 150px;
      }

      .filter-input {
        max-width: 120px;
      }

      .jobs-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        padding: 2rem 0;
      }

      .job-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        transition: all 0.3s;
        border: 1px solid var(--gray);
        position: relative;
      }

      .job-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .job-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .job-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.5rem;
      }

      .job-company {
        color: var(--primary);
        font-weight: 500;
        margin-bottom: 0.25rem;
      }

      .job-location {
        color: var(--secondary);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .job-salary {
        background: #10b981;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .job-description {
        color: var(--secondary);
        margin: 1rem 0;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .job-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .job-tag {
        background: var(--gray);
        color: var(--secondary);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
      }

      .job-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray);
      }

      .job-type {
        color: var(--primary);
        font-weight: 500;
        font-size: 0.9rem;
      }

      .loading {
        text-align: center;
        padding: 3rem;
        color: var(--secondary);
      }

      .loading i {
        margin-right: 0.5rem;
      }

      .no-jobs {
        text-align: center;
        padding: 4rem;
        color: var(--secondary);
      }

      .btn-sm {
        padding: 0.4rem 1rem;
        font-size: 0.9rem;
      }

      .job-inactive {
        opacity: 0.8;
      }

      .job-closed-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--danger);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
      }

      .recruiter-badge {
        background: var(--primary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        display: inline-block;
        margin-left: 0.5rem;
      }

      @media (max-width: 768px) {
        .search-box {
          flex-direction: column;
        }

        .filter-row {
          flex-direction: column;
          align-items: stretch;
        }

        .filter-select,
        .filter-input {
          width: 100%;
          max-width: none;
        }

        .jobs-container {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container">
        <div class="nav-content">
          <a href="index.html" class="logo">
            <i class="fas fa-bolt"></i>
            <span>JobPulse</span>
          </a>

          <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="jobs.html" class="active">Jobs</a>
            <a href="#" id="dashboardLink">Dashboard</a>

            <div id="authButtons">
              <!-- JavaScript se populate hoga -->
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <!-- Header with Search -->
      <div class="jobs-header">
        <h1>Find Your Dream Job</h1>
        <p>Browse through thousands of job opportunities</p>

        <!-- Search Box -->
        <div class="search-box">
          <input
            type="text"
            id="searchInput"
            placeholder="Search jobs by title, company, or location..."
          />
          <button id="searchBtn" class="btn btn-primary">
            <i class="fas fa-search"></i> Search
          </button>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-row">
            <select id="jobTypeFilter" class="filter-select">
              <option value="">All Job Types</option>
              <option value="FULL_TIME">Full Time</option>
              <option value="PART_TIME">Part Time</option>
              <option value="CONTRACT">Contract</option>
              <option value="INTERNSHIP">Internship</option>
              <option value="REMOTE">Remote</option>
            </select>

            <select id="experienceFilter" class="filter-select">
              <option value="">All Experience Levels</option>
              <option value="ENTRY_LEVEL">Entry Level</option>
              <option value="MID_LEVEL">Mid Level</option>
              <option value="SENIOR_LEVEL">Senior Level</option>
              <option value="EXECUTIVE">Executive</option>
            </select>

            <input
              type="number"
              id="minSalary"
              placeholder="Min Salary"
              class="filter-input"
            />
            <input
              type="number"
              id="maxSalary"
              placeholder="Max Salary"
              class="filter-input"
            />

            <button id="applyFilters" class="btn btn-outline">
              <i class="fas fa-filter"></i> Apply Filters
            </button>

            <button id="clearFilters" class="btn btn-outline">
              <i class="fas fa-times"></i> Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Alert Container -->
      <div id="alertContainer"></div>

      <!-- Loading State -->
      <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading jobs...
      </div>

      <!-- Jobs Container -->
      <div id="jobsContainer" class="jobs-container">
        <!-- Jobs will be loaded here by JavaScript -->
      </div>

      <!-- No Jobs Message -->
      <div id="noJobs" class="no-jobs" style="display: none">
        <i
          class="fas fa-briefcase"
          style="font-size: 3rem; color: #ccc; margin-bottom: 1rem"
        ></i>
        <h3>No jobs found</h3>
        <p>Try adjusting your search criteria</p>
        <button onclick="loadJobs()" class="btn btn-outline mt-3">
          <i class="fas fa-sync"></i> Refresh Jobs
        </button>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="logo">
            <i class="fas fa-bolt"></i>
            <span>JobPulse</span>
          </div>
          <p>&copy; 2024 JobPulse. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/jobs.js"></script>

    <script>
      // Load auth state and initialize page
      document.addEventListener("DOMContentLoaded", function () {
        initializePage();
      });

      // Initialize the page
      async function initializePage() {
        // Load authentication state
        auth.loadAuthState();

        // Check if user is logged in
        if (!api.isLoggedIn()) {
          window.location.href = "login.html";
          return;
        }

        // Setup dashboard link based on role
        setupDashboardLink();

        // Setup event listeners
        setupEventListeners();

        // Load jobs initially
        await loadJobs();
      }

      // Setup dashboard link based on user role
      async function setupDashboardLink() {
        const userRole = await api.getUserRole();
        const dashboardLink = document.getElementById("dashboardLink");

        if (userRole === "RECRUITER") {
          dashboardLink.textContent = "Recruiter Dashboard";
          dashboardLink.href = "recruiter-dashboard.html";
        } else if (userRole === "JOB_SEEKER") {
          dashboardLink.textContent = "My Applications";
          dashboardLink.href = "my-applications.html";
        } else if (userRole === "ADMIN") {
          dashboardLink.textContent = "Admin Panel";
          dashboardLink.href = "admin-dashboard.html";
        }
      }

      // Setup all event listeners
      function setupEventListeners() {
        // Search button
        document
          .getElementById("searchBtn")
          .addEventListener("click", performSearch);

        // Search input enter key
        document
          .getElementById("searchInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") performSearch();
          });

        // Apply filters button
        document
          .getElementById("applyFilters")
          .addEventListener("click", applyFilters);

        // Clear filters button
        document
          .getElementById("clearFilters")
          .addEventListener("click", clearFilters);

        // Filter dropdown changes
        document
          .getElementById("jobTypeFilter")
          .addEventListener("change", function () {
            if (this.value) applyFilters();
          });

        document
          .getElementById("experienceFilter")
          .addEventListener("change", function () {
            if (this.value) applyFilters();
          });
      }

      // Perform search
      function performSearch() {
        const searchTerm = document.getElementById("searchInput").value;
        loadJobs({ title: searchTerm });
      }

      // Apply filters
      function applyFilters() {
        const filters = {
          jobType: document.getElementById("jobTypeFilter").value,
          experienceLevel: document.getElementById("experienceFilter").value,
          minSalary: document.getElementById("minSalary").value || null,
          maxSalary: document.getElementById("maxSalary").value || null,
        };

        // Remove null/empty values
        Object.keys(filters).forEach((key) => {
          if (!filters[key]) delete filters[key];
        });

        loadJobs(filters);
      }

      // Clear all filters
      function clearFilters() {
        document.getElementById("jobTypeFilter").value = "";
        document.getElementById("experienceFilter").value = "";
        document.getElementById("minSalary").value = "";
        document.getElementById("maxSalary").value = "";
        document.getElementById("searchInput").value = "";

        loadJobs();
      }

      // Load jobs with filters
      async function loadJobs(filters = {}) {
        const loading = document.getElementById("loading");
        const jobsContainer = document.getElementById("jobsContainer");
        const noJobs = document.getElementById("noJobs");

        // Show loading state
        loading.style.display = "block";
        jobsContainer.innerHTML = "";
        noJobs.style.display = "none";
        jobsManager.clearError();

        try {
          let jobs = [];

          // Check what type of request to make
          if (filters.title || filters.location || filters.company) {
            // Search with terms
            jobs = await jobsManager.searchJobs(filters.title || "", filters);
          } else if (Object.keys(filters).length > 0) {
            // Filter without search terms
            jobs = await jobsManager.filterJobs(filters);
          } else {
            // Get all jobs
            jobs = await jobsManager.fetchJobs();
          }

          // Hide loading
          loading.style.display = "none";

          // Check if jobs were found
          if (jobs.length === 0) {
            noJobs.style.display = "block";
            return;
          }

          // Display jobs
          displayJobs(jobs);
        } catch (error) {
          console.error("Error loading jobs:", error);
          loading.style.display = "none";
        }
      }

      // Display jobs in the container
      function displayJobs(jobs) {
        const jobsContainer = document.getElementById("jobsContainer");
        const userRole = localStorage.getItem("userRole");

        jobs.forEach((job) => {
          const jobCard = createJobCard(job, userRole);
          jobsContainer.appendChild(jobCard);
        });
      }

      // Create job card HTML
      function createJobCard(job, userRole) {
        const div = document.createElement("div");

        // Check if job is active
        const isActive = job.active !== false;

        // Format salary
        const formattedSalary = job.salary
          ? `$${job.salary.toLocaleString()}`
          : "Negotiable";

        // Format job type
        const jobType = job.jobType
          ? job.jobType.replace("_", " ")
          : "Not specified";

        // Format experience level
        const experience = job.experienceLevel
          ? job.experienceLevel.replace("_", " ")
          : "Any experience";

        // Truncate description
        const description = job.description
          ? job.description.length > 150
            ? job.description.substring(0, 150) + "..."
            : job.description
          : "No description provided";

        // Format deadline if exists
        let deadlineBadge = "";
        if (job.deadline) {
          const deadlineDate = new Date(job.deadline);
          const today = new Date();
          const daysLeft = Math.ceil(
            (deadlineDate - today) / (1000 * 60 * 60 * 24)
          );

          if (daysLeft > 0) {
            deadlineBadge = `
                        <span class="job-tag" style="background: #fef3c7; color: #92400e;">
                            <i class="fas fa-clock"></i> ${daysLeft} days left
                        </span>
                    `;
          }
        }

        // Determine button based on user role and job status
        let actionButton = "";
        if (userRole === "JOB_SEEKER" && isActive) {
          actionButton = `
                    <button class="btn btn-primary btn-sm" onclick="viewJobDetails(${job.id})">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                `;
        } else if (userRole === "RECRUITER") {
          actionButton = `
                    <button class="btn btn-primary btn-sm" onclick="viewJobDetails(${job.id})">
                        <i class="fas fa-chart-bar"></i> Manage
                    </button>
                `;
        } else if (!isActive) {
          actionButton = `
                    <button class="btn btn-outline btn-sm" disabled>
                        <i class="fas fa-lock"></i> Job Closed
                    </button>
                `;
        } else {
          actionButton = `
                    <button class="btn btn-primary btn-sm" onclick="viewJobDetails(${job.id})">
                        <i class="fas fa-eye"></i> View
                    </button>
                `;
        }

        div.className = `job-card ${isActive ? "" : "job-inactive"}`;
        div.innerHTML = `
                ${
                  !isActive
                    ? '<span class="job-closed-badge">CLOSED</span>'
                    : ""
                }
                
                <div class="job-header">
                    <div>
                        <h3 class="job-title">${
                          job.title || "Untitled Job"
                        }</h3>
                        <p class="job-company">
                            ${job.company || "Company not specified"}
                            ${
                              job.postedBy
                                ? `<span class="recruiter-badge">Posted by ${job.postedBy}</span>`
                                : ""
                            }
                        </p>
                        <p class="job-location">
                            <i class="fas fa-map-marker-alt"></i> ${
                              job.location || "Location not specified"
                            }
                        </p>
                    </div>
                    <div class="job-salary">${formattedSalary}</div>
                </div>
                
                <p class="job-description">${description}</p>
                
                <div class="job-tags">
                    <span class="job-tag">${jobType}</span>
                    <span class="job-tag">${experience}</span>
                    ${deadlineBadge}
                    ${
                      job.applicationCount
                        ? `
                        <span class="job-tag" style="background: #dbeafe; color: #1e40af;">
                            <i class="fas fa-users"></i> ${job.applicationCount} applicants
                        </span>
                    `
                        : ""
                    }
                </div>
                
                <div class="job-footer">
                    <span class="job-type">
                        <i class="fas fa-briefcase"></i> ${jobType}
                    </span>
                    <div>
                        ${actionButton}
                    </div>
                </div>
            `;

        return div;
      }

      // View job details
      async function viewJobDetails(jobId) {
        try {
          const job = await jobsManager.getJobById(jobId);
          if (job) {
            // Store job in session storage for details page
            sessionStorage.setItem("currentJob", JSON.stringify(job));
            window.location.href = `job-details.html?id=${jobId}`;
          } else {
            auth.showAlert("Job not found", "error", "alertContainer");
          }
        } catch (error) {
          console.error("Error viewing job:", error);
          auth.showAlert(
            "Error loading job details",
            "error",
            "alertContainer"
          );
        }
      }
    </script>
    <script>
      // WebSocket for job seekers to receive new job notifications
      function setupJobSeekerWebSocket() {
        console.log("Setting up job seeker WebSocket...");

        // Check if libraries are loaded
        if (typeof SockJS === "undefined" || typeof Stomp === "undefined") {
          console.error("WebSocket libraries not loaded. Loading them now...");
          // Load libraries dynamically
          loadWebSocketLibraries().then(() => {
            console.log("Libraries loaded, retrying WebSocket setup...");
            setTimeout(setupJobSeekerWebSocket, 1000);
          });
          return;
        }

        const token = localStorage.getItem("token");
        if (!token) {
          console.log("No token found, skipping WebSocket setup");
          return;
        }

        const user = JSON.parse(localStorage.getItem("currentUser") || "{}");
        if (user.role !== "JOB_SEEKER") {
          console.log("Not a job seeker, skipping WebSocket");
          return;
        }

        // Don't connect if already connected
        if (
          window.jobSeekerStompClient &&
          window.jobSeekerStompClient.connected
        ) {
          console.log("Job seeker WebSocket already connected");
          return;
        }

        try {
          console.log("Creating SockJS connection for job seeker...");
          const socket = new SockJS("http://localhost:8080/ws");
          const stompClient = Stomp.over(socket);
          stompClient.debug = null;

          const headers = {
            Authorization: `Bearer ${token}`,
          };

          stompClient.connect(
            headers,
            function (frame) {
              console.log("âœ… Job Seeker WebSocket connected:", frame);
              window.jobSeekerStompClient = stompClient;
              window.jobSeekerConnected = true;

              // Subscribe to new jobs topic
              stompClient.subscribe("/topic/new-jobs", function (message) {
                try {
                  const notification = JSON.parse(message.body);
                  console.log(
                    "ðŸŽ¯ New job notification received:",
                    notification
                  );

                  if (notification.type === "NEW_JOB") {
                    // Show notification
                    showJobNotification(notification);

                    // Refresh jobs list if on jobs page
                    if (
                      window.loadJobs &&
                      typeof window.loadJobs === "function"
                    ) {
                      console.log("Refreshing jobs list...");
                      setTimeout(window.loadJobs, 1000);
                    }

                    // Update job count badge if exists
                    updateNewJobBadge();
                  }
                } catch (error) {
                  console.error("Error parsing job notification:", error);
                }
              });

              // Subscribe to general notifications
              stompClient.subscribe("/topic/notifications", function (message) {
                try {
                  const notification = JSON.parse(message.body);
                  console.log("ðŸ“¢ General notification:", notification);
                } catch (error) {
                  console.error("Error parsing general notification:", error);
                }
              });

              console.log("âœ… Job seeker WebSocket subscriptions created");
            },
            function (error) {
              console.error("âŒ Job seeker WebSocket connection error:", error);
              window.jobSeekerConnected = false;

              // Try to reconnect after 10 seconds
              setTimeout(() => {
                if (!window.jobSeekerConnected) {
                  console.log(
                    "Attempting to reconnect job seeker WebSocket..."
                  );
                  setupJobSeekerWebSocket();
                }
              }, 10000);
            }
          );
        } catch (error) {
          console.error("âŒ Failed to setup job seeker WebSocket:", error);
        }
      }

      // Function to load WebSocket libraries dynamically
      function loadWebSocketLibraries() {
        return new Promise((resolve) => {
          // Check if already loaded
          if (typeof SockJS !== "undefined" && typeof Stomp !== "undefined") {
            resolve();
            return;
          }

          let loadedCount = 0;

          const loadScript = (src, onload) => {
            const script = document.createElement("script");
            script.src = src;
            script.onload = onload;
            script.onerror = () => {
              console.error("Failed to load:", src);
              loadedCount++;
              if (loadedCount === 2) resolve();
            };
            document.head.appendChild(script);
          };

          loadScript(
            "https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js",
            () => {
              console.log("âœ… SockJS loaded");
              loadedCount++;
              if (loadedCount === 2) resolve();
            }
          );

          loadScript(
            "https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js",
            () => {
              console.log("âœ… STOMP loaded");
              loadedCount++;
              if (loadedCount === 2) resolve();
            }
          );
        });
      }

      function showJobNotification(notification) {
        console.log("Showing job notification:", notification);

        // Create notification toast
        const toast = document.createElement("div");
        toast.className = "toast toast-info";
        toast.innerHTML = `
            <i class="fas fa-briefcase"></i>
            <div>
                <strong>${notification.message || "New Job Posted!"}</strong>
                <p>${notification.company || ""} - Click to view</p>
            </div>
            <button class="toast-close">&times;</button>
        `;

        // Make it clickable
        toast.style.cursor = "pointer";
        toast.onclick = function () {
          if (notification.jobId) {
            window.location.href = `job-details.html?id=${notification.jobId}`;
          } else {
            window.location.href = "jobs.html";
          }
        };

        document.body.appendChild(toast);

        // Show with animation
        setTimeout(() => toast.classList.add("show"), 10);

        // Auto remove after 10 seconds
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 10000);

        // Close button
        toast.querySelector(".toast-close").onclick = function (e) {
          e.stopPropagation();
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        };
      }

      function updateNewJobBadge() {
        // Update badge if exists
        const badge = document.getElementById("newJobsBadge");
        if (badge) {
          const currentCount = parseInt(badge.textContent) || 0;
          badge.textContent = currentCount + 1;
          badge.style.display = "inline-block";
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, setting up job seeker WebSocket...");

        // First load WebSocket libraries
        loadWebSocketLibraries().then(() => {
          console.log("All WebSocket libraries loaded");

          // Setup WebSocket after delay
          setTimeout(() => {
            setupJobSeekerWebSocket();
          }, 2000);
        });

        // Add new jobs badge to navbar if not exists
        setTimeout(() => {
          const jobsLink = document.querySelector('a[href="jobs.html"]');
          if (jobsLink && !document.getElementById("newJobsBadge")) {
            const badge = document.createElement("span");
            badge.id = "newJobsBadge";
            badge.className = "notification-badge";
            badge.style.display = "none";
            badge.textContent = "0";
            jobsLink.appendChild(badge);
          }
        }, 1000);
      });

      // Also try setup when auth is loaded
      window.addEventListener("load", function () {
        console.log("Window loaded, checking WebSocket...");
        setTimeout(() => {
          if (
            window.jobSeekerStompClient &&
            !window.jobSeekerStompClient.connected
          ) {
            setupJobSeekerWebSocket();
          }
        }, 3000);
      });

      // Test function (for debugging)
      window.testJobNotification = function () {
        const testNotif = {
          type: "NEW_JOB",
          message: "ðŸŽ¯ Test Job: Senior Developer at Google",
          jobId: 1,
          company: "Google",
          jobTitle: "Senior Developer",
          timestamp: new Date().toISOString(),
        };
        showJobNotification(testNotif);
        console.log("Test notification shown");
      };
    </script>
  </body>
</html>
